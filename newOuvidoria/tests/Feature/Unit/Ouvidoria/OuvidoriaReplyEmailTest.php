<?php

namespace Tests\Feature\Unit\Ouvidoria;

use App\Helpers\helpers;
use App\Models\Ouvidoria;
use App\Models\User;
use Tests\TestCase;

class OuvidoriaReplyEmailTest extends TestCase
{
    private $user;

    protected function setUp(): void
    {
        parent::setUp();

        $user = User::create([
            'nome' => 'MOISES ABREU',
            'usuario' => 'moises.rodrigues',
            'setor_id' => 2,
            'nivel_id' => 2
        ]);

        auth()->login($user);

        $this->user = $user;
    }


    protected function tearDown(): void
    {
        auth()->logout();
        parent::tearDown(); // TODO: Change the autogenerated stub
    }

    public function testResponderOcorrenciaPorEmailSucesso()
    {
        $form = $this->form();

        $ouvidoriaInstance = Ouvidoria::create($form->data);

        $ocorrenciaData = (object) [
            'data' => [
                'ocorrencia_id' => $ouvidoriaInstance->id,
                'status_ocorrencia_id' => 3,
                'mensagem' => 'MENSAGEM PREENCHIDA PELO USUARIO'
            ]
        ];

        $this->put('admin/ouvidoria/responder', $ocorrenciaData->data);

        $this->assertDatabaseHas('ouvidoria_historico', [
                'ocorrencia_id' => $ocorrenciaData->data['ocorrencia_id'],
                'status_ocorrencia_id' => $ocorrenciaData->data['status_ocorrencia_id']
        ]);

        $ouvidoriaUpdatedInstance = Ouvidoria::where(['status_id' => $ocorrenciaData->data['status_ocorrencia_id'], 'setor_responsavel_id' => $this->user->setor_id])->get()->first();

        $this->assertTrue(!is_null($ouvidoriaUpdatedInstance));
    }

    private function form(){
        $protocol = new helpers();

        return (object) [
            'data' => [
                'protocolo' => $protocol->generateProtocol(2),
                'nome' => 'Moises abreu',
                'contato' => 'moises.rodrigues@unifametro.edu.br',
                'descricao' => 'Mussum Ipsum, cacilds vidis litro abertis. Sapien in monti palavris qui num significa nadis i pareci latim. Paisis, filhis, espiritis santis. Per aumento de cachacis, eu reclamis. Interagi no mÃ©, cursus quis, vehicula ac nisi',
                'categoria_id' => 1,
                'demandante_id' => 2,
                'campus_id' => 5
            ],
        ];
    }
}
